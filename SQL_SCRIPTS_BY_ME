WITH TEMP(SUBS_KEY,SUBS_MSISDN,CIRCLE_ID,APPORTION_START_DT, 
APPORTION_END_DT,
BASE_MONTH,BASE_YEAR,REPORT_MONTH,REPORT_YEAR,
RCHG_MRP_AMT,
VOUCHER_GRP,
APPORTION_AMT,
MONTH_WISE_DAYS,
DEFERMENT_AMT,
TOTAL_DEFERMENT,
RCHG_VALIDITY_IN_DAYS,
RANK)
AS
(
SELECT SUBS_KEY,SUBS_MSISDN,CIRCLE_ID,APPORTION_START_DT,
APPORTION_END_DT,
BASE_MONTH,BASE_YEAR,REPORT_MONTH,REPORT_YEAR,
RCHG_MRP_AMT,
VOUCHER_GRP,
APPORTION_AMT,
MONTH_WISE_DAYS,
DEFERMENT_AMT,
TOTAL_DEFERMENT,
RCHG_VALIDITY_IN_DAYS,
RANK () OVER(PARTITION BY SUBS_KEY,APPORTION_END_DT ORDER BY REPORT_MONTH,APPORTION_START_DT)
FROM
(
SELECT SUBS_KEY,SUBS_MSISDN,CIRCLE_ID,APPORTION_START_DT,
APPORTION_END_DT,
BASE_MONTH,BASE_YEAR,REPORT_MONTH,REPORT_YEAR,
RCHG_MRP_AMT,
VOUCHER_GRP,
APPORTION_AMT,
MONTH_WISE_DAYS,
APPORTION_AMT * MONTH_WISE_DAYS AS DEFERMENT_AMT,
APPORTION_AMT * RCHG_VALIDITY_IN_DAYS AS TOTAL_DEFERMENT,
RCHG_VALIDITY_IN_DAYS
FROM AGGTEMP.DEFERMENT_DAY_WISE_3
)
),
TEMP2(SUBS_KEY,SUBS_MSISDN,CIRCLE_ID,APPORTION_START_DT,
APPORTION_END_DT,
BASE_MONTH,BASE_YEAR,REPORT_MONTH,REPORT_YEAR,
RCHG_MRP_AMT,
VOUCHER_GRP,
APPORTION_AMT,
MONTH_WISE_DAYS,
DEFERMENT_AMT,
TOTAL_DEFERMENT,
RCHG_VALIDITY_IN_DAYS,
RANK)
AS
(
SELECT A.SUBS_KEY,A.SUBS_MSISDN,A.CIRCLE_ID,A.APPORTION_START_DT,
A.APPORTION_END_DT,
A.BASE_MONTH,A.BASE_YEAR,A.REPORT_MONTH,A.REPORT_YEAR,
A.RCHG_MRP_AMT,
A.VOUCHER_GRP,
A.APPORTION_AMT,
A.MONTH_WISE_DAYS,
A.DEFERMENT_AMT,
A.TOTAL_DEFERMENT,A.RCHG_VALIDITY_IN_DAYS,A.RANK FROM TEMP A WHERE A.RANK=1
UNION ALL
SELECT A.SUBS_KEY,A.SUBS_MSISDN,A.CIRCLE_ID,A.APPORTION_START_DT, 
A.APPORTION_END_DT,
A.BASE_MONTH,A.BASE_YEAR,A.REPORT_MONTH,A.REPORT_YEAR,
A.RCHG_MRP_AMT,
A.VOUCHER_GRP,
A.APPORTION_AMT,
A.MONTH_WISE_DAYS,
A.DEFERMENT_AMT+B.DEFERMENT_AMT,
A.TOTAL_DEFERMENT,A.RCHG_VALIDITY_IN_DAYS,A.RANK FROM TEMP A, TEMP2 B WHERE A.RANK=B.RANK+1 
AND A.SUBS_KEY=B.SUBS_KEY AND A.APPORTION_END_DT=B.APPORTION_END_DT
)SELECT * FROM TEMP2 ORDER BY RANK 